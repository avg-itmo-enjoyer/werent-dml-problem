# Тестовое задание №1 для компании WeRent

## Задание:  
Напишите простой PHP-скрипт, который:
- Выводит сообщение в консоль,
- "Засыпает" на 1 секунду (sleep(1)),
- Защищён от повторного запуска, если уже работает (блокировка на Redis).

Нельзя использовать никакие фреймворки — только чистый PHP и расширение Redis.  

Для проверки работы скрипта, необходимо написать второй скрипт на Node.js, который будет запускать PHP-скрипт 1000 раз одновременно, можно в цикле без задержки.  

Запуск должен производиться из командной строки (CLI), например, с помощью child_process.spawnили exec.  

Убедитесь, что каждый запуск PHP-скрипта пишет в консоль:
- начало выполнения,
- завершение выполнения,
- и можно понять, какой конкретно запуск это был (например, через порядковый номер или уникальный ID).

## Реализация:
Был разработан класс RedisLock. Его публичный API представляет из себя:
- Метод для получения блокировки на ресурс по имени данного ресурса:
    ```php
    public function lock(string $resource, int $ttlMillis): ?string;
    void;
    ```
- Метод для снятия блокировки с ресурса по имени и уникальному id блокировки:
    ```php
    public function unlock(string $resource, string $lock_uuid): void;
    ```
- Метод для выполнения критической секции в блокирующем режиме:
    ```php
    public function runBlocking(string $resource, callable $criticalSection): void;
    ```
Концептуально алгоритм работает так:
1. Вызывается метод ___lock("\<resource-name\>", \<ttl-in-milliseconds\>)___ с передаваемыми в него параметрами имени блокируемого ресурса и времени жизни блокировки (чтобы при непредвиденных обстоятельствах блокировка на ресурс отпускалась хотя бы по таймауту);  
2. Внутри данного метода производится попытка установить в ___Redis___ по ключу с именем блокировки уникальный идентификатор, если такового ключа в нём ещё нет;
3. В случае успеха метод возвращает идентификатор блокировки. В случае неудачи - ___null___;
4. Если блокировка на ресурс была успешно получена - выполняется полезная нагрузка;
5. После выполнения полезной нагрузки вызывается метод ___unlock("\<resource-name\>", "\<lock-id\>")___;
6. Внутри данного метода производится проверка хранимого идентификатора блокировки на равенство с получаемым в качестве аргумента и при совпадении - блокировка отпускается;

## Запуск:
Для запуска потребуется OCI runtime (Docker, Podman или иная реализация).  
Команда запуска ___Redis___:
```sh
podman compose -f ./compose.yaml up -d --build
```

После запуска ___Redis___ можно запускать [скрипт](main.js)